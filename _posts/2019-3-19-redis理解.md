---
title:  "redis理解"
categories: server
---
# 概述
redis，作为简单，灵活，高效的内存数据库，被广泛使用。通过tcp直接存取，优势是速度快，并发高，缺点是数据类型有限，查询功能不强，一般用作缓存。经常用来缓存数据，存储全局共享的数据，处理排行榜等。

## 特点

- 渐进hash的hashmap（消除了大的hashmap在rehash时，需要长时等待）
- value不提供查询，如果想查询，用一个hash来记录索引。
- 五种数据结构（string hashes list sets sorted sets）
- 支持分布式
- 单线程

## redis的落地方式
- 快照，fork进程，把进程dump到磁盘中
- AOF 方式，把所有操作保存在磁盘中

# 实现
    
用c语言实现，核心就是实现一个高效的hashtable。其value是个union。提供redis的五种数据结构。union对数字的有单独区分，提供更高效的效率。

```c
union {
    void *val;
    uint64_t u64;
    int64_t s64;
    double d;
} v;
```

## 高效的hashmap

用两个hashmap。当需要扩容的时候，扩容map2，将map1慢慢rehash到map2中。如果在rehashing。在增删改查的过程中，都会rehash一次，在服务器空闲的时候，会rehash一段时间。以此实现渐进的rehash过程。

## 线程模型

单线程的模式，基于event loop。网络IO和逻辑处理都在主线程处理。另外有3个BIO线程，在bio.c中定义，做持久化相关的操作。

在linux系统中，用epoll来实现异步io。用[sds](https://github.com/antirez/sds)来做动态内存分配。


# 配置

```bash
maxmemory-policy noeviction  #数据淘汰策略
```

# 集群

redis cluster 不用consistent hashing。而是用hash slot。

redis是异步同步write到replication，所以可能会lose write。redis cluster 提高了高可靠和弱的一致性。